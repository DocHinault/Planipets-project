const roadmap2026 = [
  {
    id: "2026-01",
    monthLabel: "Janvier 2026",
    monthShort: "Jan.",
    theme: "Fondations & clarification de l’offre Pro",
    icon: "calendar",
    summary: "Clarifier la promesse Pro, cadrer les KPIs et poser les bases produit.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Aligner la promesse",
        tasks: [
          "Atelier sur la promesse centrale Pro.",
          "Inventaire des pages produit et média existantes.",
          "Définition des premiers KPIs prioritaires.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Maquettage & messages",
        tasks: [
          "Rédaction des messages clés et du nouveau hero Pro.",
          "Maquettage des sections de la landing Pro.",
          "Préparation du plan d’audit UX.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Tests de cohérence",
        tasks: [
          "Tests de cohérence des parcours existants.",
          "Collecte des 404 et irritants majeurs.",
          "Définition du tableau de suivi des corrections.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Synthèse & planification",
        tasks: [
          "Synthèse de l’audit et priorisation des corrections.",
          "Partage des KPIs retenus avec l’équipe.",
          "Planification du sprint correctif de février.",
        ],
      },
    ],
  },
  {
    id: "2026-02",
    monthLabel: "Février 2026",
    monthShort: "Fév.",
    theme: "Hygiène produit & stack data",
    icon: "layers",
    summary: "Corrections rapides, uniformisation des formulaires et instrumentation des événements clés.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Traiter les irritants",
        tasks: [
          "Traiter les pages les plus vues selon l’audit.",
          "Uniformiser labels, CTA et messages d’erreur.",
          "Préparer les gabarits de formulaires communs.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Accessibilité & formulaires",
        tasks: [
          "Implémenter les correctifs rapides identifiés.",
          "Repasser sur l’accessibilité des formulaires.",
          "Lister les événements produit à tracer.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Brancher le tracking",
        tasks: [
          "Brancher le tracking sur les parcours critiques.",
          "Tester les événements en staging.",
          "Préparer un mini dashboard de suivi.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Validation data",
        tasks: [
          "Valider les données sur 7 à 10 jours.",
          "Documenter la base de KPIs.",
          "Lister les manques pour mars.",
        ],
      },
    ],
  },
  {
    id: "2026-03",
    monthLabel: "Mars 2026",
    monthShort: "Mars",
    theme: "Spécification boutique & gamification",
    icon: "rocket",
    summary: "Choix catalogue pilote, règles de commission et conception des niveaux Pro.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Benchmark & catalogue",
        tasks: [
          "Benchmark rapide des partenaires boutique.",
          "Cartographier catalogue pilote (food, accessoires, services).",
          "Lister les dépendances techniques.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Règles & maquettes",
        tasks: [
          "Poser les règles de commission pro/Planipets.",
          "Préparer les écrans clés Pro et particulier.",
          "Écrire les premiers scénarios de niveaux Pro.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Tests avec pros",
        tasks: [
          "Ateliers avec 3 pros pilotes sur les niveaux.",
          "Affiner la table des quêtes hebdomadaires.",
          "Valider les critères d’éligibilité des produits.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Synthèse T2",
        tasks: [
          "Assembler la spécification finale.",
          "Clore les maquettes pour T2.",
          "Communiquer la vision boutique + gamification.",
        ],
      },
    ],
  },
  {
    id: "2026-04",
    monthLabel: "Avril 2026",
    monthShort: "Avr.",
    theme: "Partenaires boutique & intégration",
    icon: "handshake",
    summary: "Sélection des partenaires, mapping catalogue et premiers flux techniques.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Qualification partenaires",
        tasks: [
          "Appels de qualification avec 5 à 10 marques.",
          "Évaluation de la compatibilité technique.",
          "Choix des catégories du pilote.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Négociation & règles",
        tasks: [
          "Négociation commissions et règles de redistribution.",
          "Structuration des données produits.",
          "Définition des checklists de qualité.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Flux d’import",
        tasks: [
          "Mise en place des flux d’import (API/CSV).",
          "Écrans internes de gestion du catalogue.",
          "Tests sur échantillon réduit.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Validation pilote",
        tasks: [
          "Validation conjointe avec 2 partenaires.",
          "Plan de communication pilote.",
          "Préparation de l’onboarding pro.",
        ],
      },
    ],
  },
  {
    id: "2026-05",
    monthLabel: "Mai 2026",
    monthShort: "Mai",
    theme: "Interfaces Pro & parcours particuliers",
    icon: "layout",
    summary: "Interface recommandation Pro et parcours d’achat particulier v1.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Onglet Reco & boutique",
        tasks: [
          "Développement onglet Recommandations & Boutique.",
          "Cartes produits activables par le pro.",
          "Préparation des liens de recommandation.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Parcours commande",
        tasks: [
          "Parcours de commande particulier (produit → panier).",
          "Affichage des commissions estimées.",
          "Tests d’ergonomie avec quelques pros.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Partage & paiement",
        tasks: [
          "Ajout des QR codes et boutons de partage.",
          "Validation des flux de paiement.",
          "Rédaction des confirmations et e-mails.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Revue qualité",
        tasks: [
          "Revue qualité bout en bout.",
          "Fix des points de friction identifiés.",
          "Préparation du pilote juin.",
        ],
      },
    ],
  },
  {
    id: "2026-06",
    monthLabel: "Juin 2026",
    monthShort: "Juin",
    theme: "Cohorte pilote & coaching pros",
    icon: "users",
    summary: "Onboarding de 20–30 pros pilotes, suivi rapproché et contenus pédagogiques.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Sélection des pilotes",
        tasks: [
          "Sélection des pros pilotes.",
          "Invitation et planification des sessions live.",
          "Création du canal de support privé.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Onboarding boutique",
        tasks: [
          "Onboarding boutique + niveaux.",
          "Suivi des premières recommandations.",
          "Collecte des questions récurrentes.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Webinaires & playbooks",
        tasks: [
          "Webinaires et playbooks de scripts.",
          "Enrichissement des FAQ.",
          "Premiers mini-dashboards envoyés aux pros.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Analyse pilote",
        tasks: [
          "Analyse quantitative du pilote.",
          "Recueil des feedbacks qualitatifs.",
          "Décisions pour l’itération T3.",
        ],
      },
    ],
  },
  {
    id: "2026-07",
    monthLabel: "Juillet 2026",
    monthShort: "Juil.",
    theme: "Compte Particulier & carnet animal",
    icon: "book",
    summary: "Espace particulier v1, fiches animaux et historique de rendez-vous.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Créer le compte",
        tasks: [
          "Création du compte particulier simple.",
          "Formulaire fiche animal (nom, photo, âge).",
          "Association des RDV existants.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Historique et édition",
        tasks: [
          "Consultation et édition des fiches.",
          "Historique de RDV par animal.",
          "Tests mobiles et accessibilité.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Conseils personnalisés",
        tasks: [
          "Préparation de la connexion boutique → fiches animaux.",
          "Bloc conseils personnalisés.",
          "Collecte de feedback particuliers.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Stabilisation",
        tasks: [
          "Stabilisation et corrections.",
          "Documentation support.",
          "Annonce publique limitée.",
        ],
      },
    ],
  },
  {
    id: "2026-08",
    monthLabel: "Août 2026",
    monthShort: "Août",
    theme: "Clubs locaux & gamification douce",
    icon: "map",
    summary: "Statuts particuliers, défis bien-être et premières animations locales.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Statuts & badges",
        tasks: [
          "Conception des statuts et badges particuliers.",
          "Liste des défis bien-être pertinents.",
          "Sélection des villes/tests clubs.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Implémentation défis",
        tasks: [
          "Implémentation des défis hebdomadaires.",
          "Affichage des clubs locaux.",
          "Partenariats associatifs locaux.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Lancement pilote",
        tasks: [
          "Lancement des défis pilotes.",
          "Communication via le média.",
          "Collecte des retours clubs.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Ajustements UX",
        tasks: [
          "Ajustements UX gamification douce.",
          "Préparation des événements récurrents.",
          "Mesure de l’engagement.",
        ],
      },
    ],
  },
  {
    id: "2026-09",
    monthLabel: "Septembre 2026",
    monthShort: "Sept.",
    theme: "Boutique élargie & packages",
    icon: "box",
    summary: "Élargissement du catalogue et packages récurrents pour les pros.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Analyse des ventes",
        tasks: [
          "Analyse des ventes pilote T2/T3.",
          "Sélection de nouvelles catégories.",
          "Contact de nouveaux fournisseurs.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Packages récurrents",
        tasks: [
          "Création des packages récurrents (abos, kits).",
          "Ajustement des niveaux et plafonds.",
          "Préparation du matériel de vente pro.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Tests ambassadeurs",
        tasks: [
          "Tests packages avec pros ambassadeurs.",
          "Mise à jour des flux de commissions.",
          "Documentation claire pour les pros.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Lancement packages",
        tasks: [
          "Lancement large des packages.",
          "Suivi des revenus générés.",
          "Plan de communication Q4.",
        ],
      },
    ],
  },
  {
    id: "2026-10",
    monthLabel: "Octobre 2026",
    monthShort: "Oct.",
    theme: "Offre média & publicité",
    icon: "megaphone",
    summary: "Structuration des offres média, storytelling Rex & Minou et partenariats marques.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Inventaire des audiences",
        tasks: [
          "Inventaire des audiences et formats.",
          "Packaging des offres média/publicité.",
          "Mise à jour de la charte éditoriale.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Storytelling & médiakits",
        tasks: [
          "Renforcement de la série Rex & Minou.",
          "Création de médiakits.",
          "Prospection initiale partenaires.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Formats sponsorisés",
        tasks: [
          "Tests de formats sponsorisés pilotes.",
          "Mesure des performances.",
          "Collecte des retours audience.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Bouclage Q4",
        tasks: [
          "Finalisation des offres et tarifs.",
          "Plan de diffusion jusqu’à fin d’année.",
          "Préparation des dossiers partenaires 2027.",
        ],
      },
    ],
  },
  {
    id: "2026-11",
    monthLabel: "Novembre 2026",
    monthShort: "Nov.",
    theme: "Optimisation revenus & fidélisation",
    icon: "target",
    summary: "Optimiser l’upsell, la récurrence et le suivi des revenus générés.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Analyse revenus",
        tasks: [
          "Analyse des revenus boutique et médias.",
          "Identification des produits forts/faibles.",
          "Cadrage des scénarios d’upsell.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Automations",
        tasks: [
          "Automatiser relances et recommandations.",
          "Optimiser les scripts d’appels pros.",
          "Mettre à jour les tableaux de suivi.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Fidélisation",
        tasks: [
          "Lancer programmes de fidélité ciblés.",
          "Mesurer l’impact sur la récurrence.",
          "Interviews qualitatives clients.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Préparer décembre",
        tasks: [
          "Ajustements selon les résultats.",
          "Plan de communication fin d’année.",
          "Préparer les campagnes de fêtes.",
        ],
      },
    ],
  },
  {
    id: "2026-12",
    monthLabel: "Décembre 2026",
    monthShort: "Déc.",
    theme: "Clôture & vision 2027",
    icon: "sparkles",
    summary: "Clôturer l’année, célébrer les réussites et préparer les enjeux 2027.",
    weeks: [
      {
        label: "Semaine 1",
        subtitle: "Bilan produit",
        tasks: [
          "Bilan produit + data de l’année.",
          "Synthèse boutique, média, communauté.",
          "Identification des axes 2027.",
        ],
      },
      {
        label: "Semaine 2",
        subtitle: "Célébrer",
        tasks: [
          "Communication des succès aux communautés.",
          "Moments de célébration pros/particuliers.",
          "Collecte des témoignages phares.",
        ],
      },
      {
        label: "Semaine 3",
        subtitle: "Préparation 2027",
        tasks: [
          "Roadmap 2027 draft avec l’équipe.",
          "Planifier les premiers sprints Q1.",
          "Sélectionner les KPI de suivi.",
        ],
      },
      {
        label: "Semaine 4",
        subtitle: "Hivernage",
        tasks: [
          "Pause opérationnelle partielle.",
          "Support client allégé.",
          "Maintenance et dette technique légère.",
        ],
      },
    ],
  },
];

document.addEventListener("DOMContentLoaded", () => {
  setupNavMenus();
  setupHeaderOnScroll();
  setupTimelineRail();
  setupTimelinePreview();
  setupRevealOnScroll();
  setupProFunnel();
  setupTunnelParticulier();
  setupAdPageInteractions();
  initGamificationParticulier();
  initGamificationPro();
});

function setupNavMenus() {
  const header = document.querySelector(".site-header");
  if (!header) return;

  const toggle = header.querySelector(".nav-toggle");
  const navLinks = header.querySelector(".nav-links");
  const submenuItems = header.querySelectorAll(".nav-item.has-submenu");

  const setSubmenuState = (item, isOpen) => {
    if (!item) return;
    const submenu = item.querySelector(".nav-submenu");
    if (!submenu) return;
    item.classList.toggle("is-open", isOpen);
    item.setAttribute("aria-expanded", String(isOpen));
    submenu.setAttribute("aria-hidden", String(!isOpen));
  };

  const closeAllSubmenus = () => {
    submenuItems.forEach((item) => setSubmenuState(item, false));
  };

  if (toggle && navLinks) {
    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      const isOpen = navLinks.classList.toggle("is-open");
      toggle.setAttribute("aria-expanded", String(isOpen));
      if (!isOpen) {
        closeAllSubmenus();
      }
    });
  }

  submenuItems.forEach((item) => {
    const submenu = item.querySelector(".nav-submenu");
    if (!submenu) return;

    setSubmenuState(item, item.classList.contains("is-open"));

    const toggleSubmenu = (event) => {
      event.stopPropagation();
      const willOpen = !item.classList.contains("is-open");
      closeAllSubmenus();
      setSubmenuState(item, willOpen);
    };

    item.addEventListener("click", toggleSubmenu);
    item.addEventListener("mouseenter", () => {
      if (!window.matchMedia("(pointer: fine)").matches) return;
      closeAllSubmenus();
      setSubmenuState(item, true);
    });
    item.addEventListener("mouseleave", () => setSubmenuState(item, false));
    item.addEventListener("focusin", () => setSubmenuState(item, true));
    item.addEventListener("focusout", (event) => {
      if (item.contains(event.relatedTarget)) return;
      setSubmenuState(item, false);
    });
  });

  document.addEventListener("click", (event) => {
    if (!header.contains(event.target)) {
      closeAllSubmenus();
      if (navLinks && navLinks.classList.contains("is-open")) {
        navLinks.classList.remove("is-open");
        toggle?.setAttribute("aria-expanded", "false");
      }
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key !== "Escape") return;
    closeAllSubmenus();
    if (navLinks) navLinks.classList.remove("is-open");
    if (toggle) toggle.setAttribute("aria-expanded", "false");
  });
}

function setupHeaderOnScroll() {
  const header = document.querySelector(".site-header");
  if (!header) return;

  const toggleScrolled = () => {
    const isScrolled = window.scrollY > 14;
    header.classList.toggle("is-scrolled", isScrolled);
  };

  toggleScrolled();
  window.addEventListener("scroll", toggleScrolled, { passive: true });
}

function setupRevealOnScroll() {
  const revealElements = document.querySelectorAll(".reveal-on-scroll");
  if (!revealElements.length) return;

  if (!("IntersectionObserver" in window)) {
    revealElements.forEach((el) => el.classList.add("is-visible"));
    return;
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.3 }
  );

  revealElements.forEach((el) => observer.observe(el));
}

function setupTimelineRail() {
  const rail = document.getElementById("timelineRail");
  const monthPanel = document.getElementById("timelineMonthPanel");
  if (!rail || !monthPanel) return;

  rail.innerHTML = "";
  monthPanel.innerHTML = "";

  const nodes = [];
  let activeMonthId = roadmap2026[0]?.id;

  const selectMonth = (monthId) => {
    activeMonthId = monthId;
    nodes.forEach((node) => {
      node.classList.toggle("timeline-node--active", node.dataset.monthId === monthId);
      const plus = node.querySelector(".timeline-node-plus");
      if (plus) plus.setAttribute("aria-hidden", node.dataset.monthId === monthId ? "false" : "true");
    });
    const currentMonth = roadmap2026.find((m) => m.id === monthId);
    if (currentMonth) {
      renderMonthPanel(currentMonth);
      const activeNode = nodes.find((n) => n.dataset.monthId === monthId);
      activeNode?.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
    }
  };

  roadmap2026.forEach((month, index) => {
    const node = document.createElement("button");
    node.type = "button";
    node.className = `timeline-node ${index % 2 === 0 ? "is-top" : "is-bottom"} reveal-on-scroll`;
    node.dataset.monthId = month.id;
    node.setAttribute("aria-label", `${month.monthLabel} – ${month.theme}`);

    const dot = document.createElement("span");
    dot.className = "timeline-node-dot";

    const plus = document.createElement("span");
    plus.className = "timeline-node-plus";
    plus.innerHTML = "+";

    const stick = document.createElement("span");
    stick.className = "timeline-node-stick";

    const card = document.createElement("div");
    card.className = "timeline-card";

    const icon = document.createElement("span");
    icon.className = "timeline-card-icon";
    icon.textContent = "•";

    const title = document.createElement("h3");
    title.textContent = month.monthLabel;

    const subtitle = document.createElement("p");
    subtitle.className = "timeline-card-theme";
    subtitle.textContent = month.theme;

    const excerpt = document.createElement("p");
    excerpt.className = "timeline-card-summary";
    excerpt.textContent = month.summary;

    card.appendChild(icon);
    card.appendChild(title);
    card.appendChild(subtitle);
    card.appendChild(excerpt);

    node.appendChild(dot);
    node.appendChild(plus);
    node.appendChild(stick);
    node.appendChild(card);

    const handleActivate = (event) => {
      event.preventDefault();
      selectMonth(month.id);
    };

    node.addEventListener("click", handleActivate);
    node.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        handleActivate(event);
      }
    });

    rail.appendChild(node);
    nodes.push(node);
  });

  if (activeMonthId) {
    selectMonth(activeMonthId);
  }
}

function renderMonthPanel(month) {
  const monthPanel = document.getElementById("timelineMonthPanel");
  if (!monthPanel) return;

  monthPanel.innerHTML = "";

  const wrapper = document.createElement("div");
  wrapper.className = "month-details detail-fade-in";

  const header = document.createElement("header");
  header.className = "month-details-header";

  const title = document.createElement("h2");
  title.textContent = `${month.monthLabel} – ${month.theme}`;

  const summary = document.createElement("p");
  summary.textContent = month.summary;

  header.appendChild(title);
  header.appendChild(summary);

  const weeksContainer = document.createElement("div");
  weeksContainer.className = "month-weeks";

  (month.weeks || []).forEach((week, index) => {
    const weekArticle = document.createElement("article");
    weekArticle.className = `week-collapse ${index === 0 ? "is-open" : "is-closed"}`;

    const toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "week-toggle";

    const label = document.createElement("span");
    label.className = "week-label";
    label.textContent = week.label;

    const subtitle = document.createElement("span");
    subtitle.className = "week-subtitle";
    subtitle.textContent = week.subtitle || "";

    const chevron = document.createElement("span");
    chevron.className = "week-chevron";

    toggle.appendChild(label);
    toggle.appendChild(subtitle);
    toggle.appendChild(chevron);

    const content = document.createElement("div");
    content.className = "week-content";

    const taskList = document.createElement("ul");
    taskList.className = "task-list";

    (week.tasks || []).forEach((task) => {
      const li = document.createElement("li");
      li.textContent = task;
      taskList.appendChild(li);
    });

    content.appendChild(taskList);
    weekArticle.appendChild(toggle);
    weekArticle.appendChild(content);

    const setOpenState = (isOpen) => {
      weekArticle.classList.toggle("is-open", isOpen);
      weekArticle.classList.toggle("is-closed", !isOpen);
      content.style.maxHeight = isOpen ? `${content.scrollHeight}px` : "0px";
      content.style.opacity = isOpen ? "1" : "0";
    };

    setOpenState(index === 0);

    toggle.addEventListener("click", () => {
      const willOpen = !weekArticle.classList.contains("is-open");
      setOpenState(willOpen);
    });

    weeksContainer.appendChild(weekArticle);
  });

  wrapper.appendChild(header);
  wrapper.appendChild(weeksContainer);
  monthPanel.appendChild(wrapper);

  window.requestAnimationFrame(() => {
    wrapper.classList.add("is-visible");
    setTimeout(() => wrapper.classList.remove("detail-fade-in"), 450);
  });
}

function setupTimelinePreview() {
  const rail = document.getElementById("timelineRailPreview");
  if (!rail) return;

  rail.innerHTML = "";
  const previewMonths = [roadmap2026[0], roadmap2026[3], roadmap2026[6], roadmap2026[9]].filter(Boolean);

  previewMonths.forEach((month, index) => {
    const node = document.createElement("button");
    node.type = "button";
    node.className = `timeline-node timeline-node--preview ${index % 2 === 0 ? "is-top" : "is-bottom"}`;
    node.setAttribute("aria-label", `${month.monthLabel} – ${month.theme}`);

    const dot = document.createElement("span");
    dot.className = "timeline-node-dot";

    const plus = document.createElement("span");
    plus.className = "timeline-node-plus";
    plus.textContent = "+";

    const stick = document.createElement("span");
    stick.className = "timeline-node-stick";

    const card = document.createElement("div");
    card.className = "timeline-card timeline-card--mini";

    const title = document.createElement("h3");
    title.textContent = month.monthShort;

    const subtitle = document.createElement("p");
    subtitle.className = "timeline-card-theme";
    subtitle.textContent = month.theme;

    card.appendChild(title);
    card.appendChild(subtitle);

    node.appendChild(dot);
    node.appendChild(plus);
    node.appendChild(stick);
    node.appendChild(card);

    node.addEventListener("click", () => {
      window.location.href = "chronologie.html#timeline-2026";
    });

    rail.appendChild(node);
  });
}

const tunnelProSteps = [
  {
    id: "pro-step-1",
    order: 1,
    title: "Découverte & curiosité",
    shortDescription:
      "Le professionnel entend parler de Planipets pour la première fois, sans encore savoir si c’est pour lui.",
    context: [
      "Il voit passer une publication sur les réseaux sociaux, un mail, un salon, une recommandation d’un confrère, ou une référence depuis le site d’une mairie/association.",
      "Il sait qu’il a besoin de plus de visibilité, de mieux s’organiser, ou d’augmenter ses revenus, mais n’a pas encore de solution claire.",
    ],
    goal: [
      "Faire exister Planipets comme une option crédible et alignée avec ses valeurs, sans agressivité commerciale.",
      "Susciter suffisamment de curiosité pour qu’il clique ou demande plus d’informations.",
    ],
    messages: [
      "Tu consacres ton énergie au bien-être des animaux, Planipets t’aide à sécuriser tes revenus et ta sérénité.",
      "Une plateforme pensée pour les métiers animaliers, pas un outil générique.",
      "Tu n’es pas seul·e : d’autres pros construisent leur activité avec Planipets.",
    ],
    kpis: [
      "Nombre de pros exposés aux contenus de découverte (reach réseaux, salons, emailings).",
      "Clics vers le site Planipets ou vers une landing dédiée Pros.",
    ],
    risks: [
      "Le pro assimile Planipets à une simple plateforme de prise de rendez-vous ‘comme les autres’.",
      "Perception d’un énième outil numérique chronophage.",
    ],
    improvements: [
      "Multiplier les témoignages de pros satisfaits, en mettant en avant leurs résultats concrets.",
      "Adapter les messages par type de métier (éducateurs, toiletteurs, etc.).",
    ],
    example:
      "Post LinkedIn : « Éducateurs canins, comportementalistes, toiletteurs… et si votre plateforme de prise de rendez-vous vous aidait aussi à créer du revenu récurrent ? » avec un lien vers la page Pro.",
  },
  {
    id: "pro-step-2",
    order: 2,
    title: "Premier contact qualifié avec Planipets",
    shortDescription: "Le pro clique sur un lien et arrive sur une page Planipets orientée Pros.",
    context: [
      "Il se rend sur la landing Pros, une page média présentant Planipets ou un article qui lui parle directement.",
      "Il a quelques minutes à consacrer à la lecture, mais reste méfiant.",
    ],
    goal: [
      "Rendre la promesse Pro compréhensible en moins de 10 secondes.",
      "Donner envie de creuser davantage (scroller, télécharger une ressource, s’inscrire à un webinaire, réserver un appel).",
    ],
    messages: [
      "Planipets t’aide à stabiliser ton activité, pas à te remplacer.",
      "Tu restes maître de la relation avec tes clients, nous construisons avec toi.",
      "Objectif prioritaire : plus de visibilité, plus de rendez-vous qualifiés, plus de récurrence.",
    ],
    kpis: [
      "Taux de rebond sur la landing Pros.",
      "Clics sur les CTA (‘Découvrir les offres’, ‘Réserver un appel avec Nasser’, ‘Voir un cas concret’).",
    ],
    risks: [
      "Page trop chargée ou jargon incompréhensible pour un pro non technicien.",
      "Pro qui ne comprend pas en quoi Planipets est différent des autres plateformes.",
    ],
    improvements: [
      "Clarifier un bloc ‘En 30 secondes, ce que Planipets change pour toi’.",
      "Mettre un comparatif avant/après simple (sans dénigrer d’autres outils).",
    ],
    example:
      "Hero landing Pro : « Tu t’occupes des animaux, on s’occupe d’optimiser ton planning, tes revenus et tes recommandations. » + bouton ‘Parler à Nasser (30 min offertes)’.",
  },
  {
    id: "pro-step-3",
    order: 3,
    title: "Compréhension de la promesse & intérêt business",
    shortDescription: "Le pro commence à comprendre ce que Planipets va lui apporter concrètement.",
    context: [
      "Il lit les sections qui expliquent la boutique, la gamification, le média, les partenariats collectivités.",
      "Il se projette : ‘Est-ce que ça peut vraiment m’aider, moi, dans ma situation ?’",
    ],
    goal: [
      "Traduire la promesse en bénéfices financiers et organisationnels lisibles.",
      "Répondre implicitement aux objections classiques (commission, temps, complexité…).",
    ],
    messages: [
      "Planipets t’aide à remplir ton planning et à créer des revenus complémentaires via une boutique et des recommandations alignées avec ta pratique.",
      "Tu n’es pas un vendeur de plus : tu restes un pro du bien-être, nous t’apportons l’outil et la structure.",
      "Un accompagnement humain (Nasser et l’équipe) est là pour t’aider à t’approprier l’outil.",
    ],
    kpis: [
      "Temps passé sur la page Pro.",
      "Clics sur les sections expliquant la boutique, la gamification ou la charte bien-être.",
    ],
    risks: [
      "Promesse trop large qui donne l’impression de ‘trop beau pour être vrai’.",
      "Mélange de plusieurs messages sans hiérarchie (agenda, boutique, média…).",
    ],
    improvements: [
      "Hiérarchiser la lecture : 1) revenu & planning, 2) boutique, 3) média & légitimité.",
      "Ajouter des cas d’usage chiffrés (sans surpromesse).",
    ],
    example:
      "Bloc ‘Ce que tu gagnes’ : 3 chiffres simples (‘+X rendez-vous/mois’, ‘Y % de revenus en plus en moyenne sur la cohorte pilote’, ‘Z heures de charge mentale en moins’).",
  },
  {
    id: "pro-step-4",
    order: 4,
    title: "Rendez-vous découverte avec Nasser",
    shortDescription:
      "Le pro prend un créneau pour parler directement à Nasser et clarifier sa situation.",
    context: [
      "Il a cliqué sur un CTA de type ‘Réserver un appel’.",
      "Il est intéressé mais encore hésitant ; c’est une étape clé de conversion.",
    ],
    goal: [
      "Qualifier le pro : métier, situation actuelle, maturité numérique, objectifs.",
      "Valider s’il y a un bon fit mutuel (valeurs, type de relation souhaitée).",
    ],
    messages: [
      "L’appel n’est pas un ‘pitch’ agressif, mais un diagnostic de ta situation.",
      "On voit ensemble ce qui est réaliste pour toi sur les 6–12 prochains mois.",
      "Tu repars avec une vision plus claire, même si tu ne signes pas.",
    ],
    kpis: [
      "Nombre d’appels planifiés vs visiteurs Pro.",
      "Taux de no-show sur les appels.",
      "Taux de transformation appel → étape suivante (essai / offre).",
    ],
    risks: [
      "Pros non qualifiés qui font perdre du temps (pas le bon profil, pas prêt à s’engager, pas aligné avec la charte).",
      "No-show ou annulation de dernière minute.",
    ],
    improvements: [
      "Formulaire de pré-qualification rapide avant l’appel (souvent ‘Pourquoi tu t’intéresses à Planipets ?’).",
      "Rappel automatique + email qui insiste sur la valeur de l’appel.",
    ],
    example:
      "Mail de confirmation : « Pendant 30 minutes, on pose ta situation, tes objectifs et on regarde comment Planipets peut t’aider concrètement, sans engagement. »",
  },
  {
    id: "pro-step-5",
    order: 5,
    title: "Décision & engagement (offre choisie)",
    shortDescription:
      "Après le rendez-vous, le pro choisit (ou non) une formule d’accompagnement Planipets.",
    context: [
      "Nasser a proposé une ou deux options alignées avec la situation du pro (ex : accompagnement de base, accompagnement + boutique pilote, etc.).",
      "Le pro pèse le pour et le contre : coût, temps, risque, confiance.",
    ],
    goal: [
      "Simplifier la prise de décision avec une offre lisible, sans grille tarifaire illisible.",
      "Montrer clairement le ROI attendu et la logique de partenariat (et non d’exploitation).",
    ],
    messages: [
      "Tu peux commencer simple et monter en puissance au fur et à mesure.",
      "Nous sommes à tes côtés sur la durée : la réussite de Planipets dépend aussi de ta réussite.",
      "Tu gardes la main sur les tarifs de tes prestations ; nous apportons la structure autour.",
    ],
    kpis: [
      "Taux de signature après appel.",
      "Délai moyen entre l’appel et la décision.",
    ],
    risks: [
      "Pros qui bloquent sur le prix faute de visualiser clairement le retour sur investissement.",
      "Contrats ou conditions perçus comme flous ou trop complexes.",
    ],
    improvements: [
      "Documents récapitulant l’offre, les engagements mutuels, les exemples de trajectoires de pros.",
      "Cas pratiques adaptés au profil du pro (‘déjà bien rempli’, ‘en lancement’, ‘en reconversion’…).",
    ],
    example:
      "Document PDF ou page récap : ‘Pack Planipets Essentiel – pour consolider ton planning et tes revenus sur 6 mois’, avec 3 bullet points de résultats attendus.",
  },
  {
    id: "pro-step-6",
    order: 6,
    title: "Onboarding & configuration du compte Pro",
    shortDescription:
      "Le pro a dit oui ; il faut maintenant qu’il soit correctement installé dans l’écosystème Planipets.",
    context: [
      "Création ou vérification des accès, paramétrage de la fiche pro, planning, zones d’intervention, services, tarifs.",
      "Signature de la charte bien-être et acceptation des conditions.",
    ],
    goal: [
      "Rendre l’onboarding le plus simple possible pour ne pas perdre l’élan de la décision.",
      "Poser des bases propres : fiche claire, agenda cohérent, communication alignée.",
    ],
    messages: [
      "On t’accompagne pas à pas, tu n’es pas seul devant un formulaire.",
      "Quelques heures bien investies maintenant pour des mois plus sereins ensuite.",
      "Ta fiche reflète ta façon de travailler et ton identité professionnelle.",
    ],
    kpis: [
      "Temps moyen entre signature et fiche pro publiée.",
      "Taux de pros abandonnant avant la fin de l’onboarding.",
    ],
    risks: [
      "Onboarding perçu comme une montagne (trop d’infos à remplir, peur de mal faire).",
      "Pro perdant l’enthousiasme initial si rien n’est visible rapidement.",
    ],
    improvements: [
      "Guides pas à pas (checklist), tutoriels vidéo courts.",
      "Possibilité pour l’équipe Planipets d’aider à pré-remplir certaines sections.",
    ],
    example:
      "Checklist envoyée après signature : ‘1. Compléter ta fiche, 2. Configurer ton agenda, 3. Valider ta charte, 4. Fixer un point de suivi à 30 jours.’",
  },
  {
    id: "pro-step-7",
    order: 7,
    title: "Activation : premiers rendez-vous & premiers revenus",
    shortDescription:
      "Le pro commence à recevoir des rendez-vous via Planipets et à en voir l’impact sur son activité.",
    context: [
      "Des clients réservent via la plateforme, parfois combiné avec sa propre communication.",
      "Le pro découvre l’interface jour après jour.",
    ],
    goal: [
      "Arriver rapidement à un premier résultat visible (1er rendez-vous, 1er mois ‘différent’).",
      "Rendre concret le bénéfice de Planipets sur son planning et sa charge mentale.",
    ],
    messages: [
      "Tu peux suivre les rendez-vous et les retours clients depuis ton espace Pro.",
      "Nous sommes disponibles pour optimiser ton profil et tes pratiques si besoin.",
      "Objectif : que tu sentes vraiment la différence d’ici quelques semaines.",
    ],
    kpis: [
      "Délai entre fin d’onboarding et 1er rendez-vous généré.",
      "Nombre de rendez-vous Planipets sur les 30–60 premiers jours.",
    ],
    risks: [
      "Si les premiers résultats tardent, le pro peut douter et décrocher.",
      "Mauvaise compréhension de la responsabilité partagée (communication du pro vs apport Planipets).",
    ],
    improvements: [
      "Points de suivi proactifs à 30 et 60 jours.",
      "Plan d’actions simple si la courbe de rendez-vous ne décolle pas (ajustements fiche, zones, messages).",
    ],
    example:
      "Mail de suivi : « Tu as reçu X demandes via Planipets ce mois-ci. Voici 3 leviers concrets pour booster encore davantage. »",
  },
  {
    id: "pro-step-8",
    order: 8,
    title: "Montée en puissance : boutique, gamification & formation",
    shortDescription:
      "Une fois l’usage de base stabilisé, le pro peut accéder aux leviers avancés de Planipets.",
    context: [
      "Il utilise déjà l’agenda et la fiche pro, et a obtenu quelques résultats.",
      "On lui propose d’entrer dans le pilote boutique, d’activer la gamification et de rejoindre des modules de formation.",
    ],
    goal: [
      "Transformer Planipets en véritable moteur de développement : revenus complémentaires, visibilité, montée en compétence.",
      "Renforcer le sentiment d’appartenance à une communauté de pros qui se tirent vers le haut.",
    ],
    messages: [
      "Avec la boutique, tes recommandations deviennent une source de revenus complémentaires alignée avec ta pratique.",
      "Le système de niveaux & quêtes récompense ton engagement et la qualité de ton travail.",
      "Les formations te permettent de progresser sur le marketing, la relation client, le bien-être animal, etc.",
    ],
    kpis: [
      "Taux de pros activant la boutique.",
      "Revenus générés via les recommandations.",
      "Participation aux quêtes, lives, formations.",
    ],
    risks: [
      "Pro qui se sent submergé par trop de nouveautés d’un coup.",
      "Crainte d’être transformé en ‘vendeur’ ou de perdre en authenticité.",
    ],
    improvements: [
      "Parcours progressif : activer d’abord un seul levier (ex : boutique) puis le reste.",
      "Mettre en avant l’éthique : charte des recommandations, sélection produits, transparence des commissions.",
    ],
    example:
      "Interface Pro : onglet ‘Recommandations & Boutique’ avec un message : « Tu peux ajouter 2–3 produits qui correspondent vraiment à ta pratique, nous nous occupons du reste. »",
  },
  {
    id: "pro-step-9",
    order: 9,
    title: "Ambassadeur Planipets & co-construction",
    shortDescription: "Le pro est satisfait, fidèle, et devient un partenaire clé de Planipets.",
    context: [
      "Il a une activité stabilisée grâce à Planipets, participe aux événements, partage régulièrement des retours.",
      "Il est prêt à témoigner, recommander Planipets à d’autres pros, co-construire des features.",
    ],
    goal: [
      "Transformer ces pros en ambassadeurs visibles et reconnus.",
      "Les impliquer dans l’amélioration du produit, de la boutique et de la gamification.",
    ],
    messages: [
      "Tu fais partie des pros qui façonnent Planipets.",
      "Nous valorisons ton expertise auprès d’autres pros et du grand public.",
      "Ton retour influence directement la roadmap.",
    ],
    kpis: [
      "Nombre de pros ambassadeurs actifs.",
      "Nombre de recommandations de nouveaux pros via le parrainage.",
      "Participation à des interviews, contenus, événements.",
    ],
    risks: [
      "Ambassadeurs qui ne se sentent pas suffisamment reconnus ou écoutés.",
      "Charge disproportionnée sur quelques personnes.",
    ],
    improvements: [
      "Mettre en place un programme ambassadeur structuré (bénéfices, cadre, visibilité).",
      "Prévoir des temps réguliers d’échange (tables rondes, groupes de travail).",
    ],
    example:
      "Page média : portrait d’un pro ambassadeur expliquant comment Planipets a transformé son activité, avec une citation forte et des chiffres clés.",
  },
];

function setupProFunnel() {
  const column = document.getElementById("funnelProColumn");
  const detailCard = document.getElementById("funnelProDetail");

  if (!column || !detailCard) return;

  const detailElements = {
    title: document.getElementById("funnelProDetailTitle"),
    subtitle: document.getElementById("funnelProDetailSubtitle"),
    context: document.getElementById("funnelProContext"),
    goal: document.getElementById("funnelProGoal"),
    messages: document.getElementById("funnelProMessages"),
    kpis: document.getElementById("funnelProKpis"),
    risks: document.getElementById("funnelProRisks"),
    example: document.getElementById("funnelProExample"),
  };

  let activeStepId = tunnelProSteps[0]?.id;

  tunnelProSteps.forEach((step) => {
    const stepEl = document.createElement("div");
    stepEl.className = "funnel-step funnel-step--pro";
    stepEl.dataset.stepId = step.id;
    const scale = Math.max(0.7, 1 - (step.order - 1) * 0.04);
    stepEl.style.setProperty("--funnel-scale", scale.toString());
    stepEl.innerHTML = `
      <div class="funnel-step-order">Étape ${step.order}/9</div>
      <div class="funnel-step-title">${step.title}</div>
    `;

    stepEl.addEventListener("mouseover", () => setActiveStep(step.id));
    stepEl.addEventListener("click", () => setActiveStep(step.id));

    if (step.id === activeStepId) {
      stepEl.classList.add("funnel-step--active");
    }

    column.appendChild(stepEl);
  });

  function fillList(listEl, items) {
    if (!listEl) return;
    listEl.innerHTML = "";
    (items || []).forEach((item) => {
      const li = document.createElement("li");
      li.textContent = item;
      listEl.appendChild(li);
    });
  }

  function renderProFunnelDetail(stepId) {
    const step = tunnelProSteps.find((s) => s.id === stepId);
    if (!step) return;

    detailCard.classList.remove("detail-fade-in");
    void detailCard.offsetWidth;
    detailCard.classList.add("detail-fade-in");

    if (detailElements.title) detailElements.title.textContent = step.title;
    if (detailElements.subtitle)
      detailElements.subtitle.textContent = step.shortDescription;

    fillList(detailElements.context, step.context);
    fillList(detailElements.goal, step.goal);
    fillList(detailElements.messages, step.messages);
    fillList(detailElements.kpis, step.kpis);
    fillList(detailElements.risks, [...(step.risks || []), ...(step.improvements || [])]);

    if (detailElements.example) detailElements.example.textContent = step.example;
  }

  function setActiveStep(stepId) {
    if (!stepId || stepId === activeStepId) return;
    activeStepId = stepId;

    column.querySelectorAll(".funnel-step").forEach((stepEl) => {
      stepEl.classList.toggle(
        "funnel-step--active",
        stepEl.dataset.stepId === stepId
      );
    });

    renderProFunnelDetail(stepId);
  }

  if (activeStepId) {
    renderProFunnelDetail(activeStepId);
  }
}
const tunnelParticulierSteps = [
  {
    id: "step1",
    order: 1,
    title: "Découverte & prise de conscience",
    shortDescription:
      "Le propriétaire se rend compte qu’il a besoin d’aide pour le bien-être de son animal, sans forcément connaître Planipets.",
    context: [
      "Le chien tire en laisse, le chat fait des bêtises, le lapin s’ennuie, l’animal a peur des manipulations, etc.",
      "Le propriétaire cherche des solutions : demande des conseils à son entourage, tape des requêtes génériques sur Google, tombe sur des posts réseaux sociaux ou sur un article d’un blog.",
    ],
    role: [
      "Planipets doit apparaître dans cet horizon de solutions comme une référence sérieuse et bienveillante.",
      "Le média (articles, Rex & Minou, contenus pédagogiques) sert de porte d’entrée naturelle.",
    ],
    messages: [
      "Tu n’es pas seul·e : d’autres propriétaires vivent la même chose.",
      "Le bien-être de ton animal passe aussi par l’accompagnement de pros formés.",
      "Planipets t’aide à trouver le bon pro, près de chez toi.",
    ],
    kpis: [
      "Impressions sur les articles et posts réseaux sociaux.",
      "Clics organiques depuis Google vers le site Planipets.",
      "Durée moyenne de lecture des contenus de découverte.",
    ],
    frictions: [
      "Le propriétaire ne connaît pas Planipets et peut être méfiant face à une nouvelle plateforme.",
      "Il ne se sent pas toujours légitime à consulter un pro (peur d’être jugé, de payer cher, etc.).",
    ],
    improvements: [
      "Multiplier les preuves sociales (avis, témoignages, cas concrets).",
      "Proposer des contenus qui normalisent le recours à un pro (‘Consulter un éducateur, ce n’est pas un échec’).",
    ],
    example:
      "Post Instagram / article : « 5 signes que ton animal a besoin d’un pro (et comment ça se passe concrètement) », avec un CTA discret vers la recherche de pros sur Planipets.",
  },
  {
    id: "step2",
    order: 2,
    title: "Arrivée sur Planipets (page d’accueil / article)",
    shortDescription:
      "Le propriétaire clique sur un lien et arrive pour la première fois sur une page Planipets (home, article, page média…).",
    context: [
      "Il vient d’un moteur de recherche, d’un réseau social, d’un lien partagé par un ami, ou du site d’une mairie/asso partenaire.",
      "Il découvre le branding, les mascottes, la promesse.",
    ],
    role: [
      "Rassurer immédiatement avec une proposition de valeur claire : Planipets = plateforme pour le bien-être de son animal, avec de vrais pros.",
      "Proposer un premier chemin simple : rechercher un pro ou lire un contenu adapté à son problème.",
    ],
    messages: [
      "24/7 en quelques clics, trouve un professionnel pour le bien-être de ton animal.",
      "Des pros sélectionnés et partenaires de la charte Planipets.",
      "Tu peux commencer par poser un diagnostic léger grâce à nos contenus.",
    ],
    kpis: [
      "Taux de rebond sur la première page visitée.",
      "Clics sur la barre de recherche ou les boutons ‘Trouver un pro’.",
      "Clics vers des articles / guides liés au problème rencontré.",
    ],
    frictions: [
      "Trop d’informations en même temps, le propriétaire ne sait pas par où commencer.",
      "Promesse pas assez claire en 3 secondes (‘Planipets = quoi exactement ?’).",
    ],
    improvements: [
      "Renforcer un bloc ‘Commencer ici’ pour les nouveaux, avec 2 à 3 options maximum.",
      "Adapter certains textes de la home pour parler au particulier, sans jargon pro.",
    ],
    example:
      "Hero de la home : « Trouve un professionnel animalier près de chez toi – éducateur, comportementaliste, toiletteur, pet-sitter… » avec un champ de recherche simple et un bouton ‘Je cherche pour mon animal’.",
  },
  {
    id: "step3",
    order: 3,
    title: "Recherche & comparaison de pros",
    shortDescription:
      "Le propriétaire utilise la recherche Planipets pour lister des professionnels pertinents autour de chez lui.",
    context: [
      "Il saisit un type de besoin (éducation, massage, comportement…), une ville, ou clique sur une catégorie.",
      "Il scrute la liste : noms, photos, distances, spécialités, avis.",
    ],
    role: [
      "Aider à passer de l’angoisse à la clarté : oui, il existe des pros formés pour ce problème.",
      "Faciliter le tri par proximité, spécialité, type d’accompagnement (présentiel / à distance).",
    ],
    messages: [
      "Des pros sélectionnés pour leur sérieux et leur éthique.",
      "Filtre par localisation, spécialité et type de service.",
      "Lis les avis d’autres propriétaires comme toi.",
    ],
    kpis: [
      "Recherches effectuées par visiteur.",
      "Clics sur des fiches Pro.",
      "Taux de visiteurs qui passent de la home à une fiche Pro.",
    ],
    frictions: [
      "Trop peu de pros visibles dans certaines zones géographiques.",
      "Difficulté à comprendre les différences entre les professionnels (titres, certifications…).",
    ],
    improvements: [
      "Ajouter des filtres ou tags clairs (ex : ‘Pro spécialisé chiens réactifs’).",
      "Afficher des micro-infographies rassurantes (exemples de cas résolus).",
    ],
    example:
      "Page de liste avec un bandeau : « Résultats pour ‘chien qui tire en laisse’ à Lille – 3 professionnels trouvés » et une explication en 1 phrase de ce qu’ils font.",
  },
  {
    id: "step4",
    order: 4,
    title: "Consultation d’une fiche Pro & réassurance",
    shortDescription:
      "Le propriétaire ouvre une fiche Pro et vérifie que c’est la bonne personne pour son animal.",
    context: [
      "Il lit la description, les services, les tarifs, les zones d’intervention, les avis, etc.",
      "Il regarde si le pro ‘comprend’ ce qu’il vit.",
    ],
    role: [
      "Offrir une fiche claire, rassurante, structurée autour du besoin du propriétaire.",
      "Mettre en avant la charte Planipets, les prises en charge possibles, les avis vérifiés.",
    ],
    messages: [
      "Pro partenaire Planipets, signataire de la charte bien-être.",
      "Spécialisé dans [type de problématique].",
      "Avis vérifiés de propriétaires accompagnés.",
    ],
    kpis: [
      "Temps passé sur les fiches.",
      "Clics sur les boutons ‘Prendre rendez-vous’.",
      "Taux de conversion fiche → début de prise de RDV.",
    ],
    frictions: [
      "Problème de compréhension des tarifs ou du déroulé de la séance.",
      "Manque d’exemples concrets de résultats obtenus.",
    ],
    improvements: [
      "Ajouter un bloc ‘Comment se déroule une séance ?’ sur chaque fiche.",
      "Mettre des exemples avant/après anonymisés ou des témoignages plus détaillés.",
    ],
    example:
      "Bloc sur la fiche : « En pratique : 1er rendez-vous d’1h pour comprendre votre situation, puis 2 à 3 séances de suivi si besoin. »",
  },
  {
    id: "step5",
    order: 5,
    title: "Prise de rendez-vous",
    shortDescription: "Le propriétaire est convaincu et clique sur ‘Prendre rendez-vous’.",
    context: [
      "Il choisit un créneau, un lieu (domicile, cabinet, à distance), et renseigne les infos de base (animal, coordonnées).",
    ],
    role: [
      "Rendre le tunnel de réservation ultra simple, rapide et rassurant.",
      "Montrer clairement ce qui va se passer après validation du rendez-vous.",
    ],
    messages: [
      "Quelques clics pour réserver, tu peux toujours modifier ou annuler selon les conditions du pro.",
      "Tes informations sont protégées et uniquement utilisées pour ton rendez-vous.",
      "Tu recevras une confirmation par mail/SMS.",
    ],
    kpis: ["Taux de conversion fiche → réservation confirmée.", "Abandons de réservation (où, combien)."],
    frictions: ["Formulaire trop long ou peu clair.", "Doute sur la politique d’annulation / de paiement."],
    improvements: [
      "Limiter le nombre de champs obligatoires, clarifier les messages d’erreur.",
      "Afficher une mini FAQ ‘avant de confirmer’ (annulation, paiement, durée de la séance).",
    ],
    example:
      "Écran de réservation : « Choisis ton créneau – 60 minutes – 50 € · En présentiel chez le pro à [adresse]. »",
  },
  {
    id: "step6",
    order: 6,
    title: "Confirmation & préparation",
    shortDescription:
      "Le rendez-vous est confirmé ; on prépare le propriétaire et son animal pour que la séance se passe au mieux.",
    context: ["Le propriétaire reçoit un email / SMS de confirmation avec les détails pratiques."],
    role: ["Rassurer, réduire le no-show, préparer le terrain pour une séance utile."],
    messages: [
      "Rappel de la date, heure, lieu, durée.",
      "Conseils spécifiques (ex : ne pas nourrir l’animal juste avant, amener des friandises, carnet de santé si besoin…).",
      "Lien pour reprogrammer/annuler si nécessaire.",
    ],
    kpis: ["Taux de no-show.", "Taux de rendez-vous reprogrammés."],
    frictions: ["Mail peu clair, propriétaire qui ne retrouve plus les infos."],
    improvements: [
      "Templates de mails/SMS plus pédagogiques.",
      "Lien direct vers une mini-fiche ‘Comment bien préparer le rendez-vous ?’.",
    ],
    example:
      "Mail : « Bonjour, votre rendez-vous avec [Nom du pro] est confirmé le [date] à [heure]. Pensez à venir avec… »",
  },
  {
    id: "step7",
    order: 7,
    title: "Rendez-vous & expérience réelle",
    shortDescription:
      "Le propriétaire rencontre le pro ; cette expérience conditionne la confiance future envers Planipets.",
    context: [
      "L’essentiel se déroule en dehors de l’interface Planipets, mais cela reste une étape clé du tunnel.",
    ],
    role: [
      "S’assurer que les pros référencés respectent la charte bien-être et les standards de qualité.",
      "Recueillir ensuite le feedback du propriétaire pour améliorer le matching.",
    ],
    messages: [
      "Planipets reste disponible après le rendez-vous pour suivre ton expérience.",
      "Tu peux partager ton ressenti pour aider d’autres propriétaires.",
    ],
    kpis: ["Satisfaction post-rendez-vous (notes/avis).", "Taux de réclamation / demandes de support."],
    frictions: ["Décalage entre les attentes et la séance réelle (durée, méthode, résultats)."],
    improvements: [
      "Affiner la description des services sur les fiches.",
      "Mettre en place un canal de support si un rendez-vous se passe mal.",
    ],
    example:
      "Message post-séance : « Comment s’est passé ton rendez-vous avec [Nom du pro] ? Dis-le-nous en 1 minute. »",
  },
  {
    id: "step8",
    order: 8,
    title: "Suivi & retour d’expérience",
    shortDescription:
      "Après le rendez-vous, Planipets sollicite un avis et propose des contenus complémentaires.",
    context: ["Le propriétaire reçoit un mail quelques jours après la séance."],
    role: [
      "Transformer une expérience ponctuelle en relation suivie.",
      "Collecter des avis utiles pour les autres propriétaires et pour le pro.",
    ],
    messages: [
      "Ton avis compte pour aider le pro et les autres propriétaires.",
      "Voici quelques ressources pour aller plus loin (articles, vidéos, petits exercices).",
    ],
    kpis: ["Taux de collecte d’avis.", "Clics sur les contenus de suivi."],
    frictions: ["Propriétaire qui ne voit pas l’intérêt de laisser un avis ou manque de temps."],
    improvements: [
      "Rendre le formulaire d’avis ultra court (note + 2–3 questions max).",
      "Montrer concrètement comment les avis aident le pro.",
    ],
    example:
      "Mail : « Peux-tu nous dire en 3 clics comment s’est passée ta séance ? Note, ce que tu as aimé, ce qu’on peut améliorer. »",
  },
  {
    id: "step9",
    order: 9,
    title: "Fidélisation & multi-services",
    shortDescription:
      "Le propriétaire adopte Planipets comme réflexe pour le suivi du bien-être de son animal.",
    context: [
      "Il revient pour d’autres rendez-vous, pour un autre animal, ou pour un autre type de pro.",
      "Il peut rejoindre un club local, suivre des contenus, profiter de la boutique.",
    ],
    role: [
      "Devenir la plateforme de référence du propriétaire pour tous les sujets bien-être animal.",
      "Créer des parcours récurrents (rappels, clubs, recommandations de produits/service).",
    ],
    messages: [
      "Ton compte Planipets devient le carnet de vie de ton animal.",
      "Retrouve l’historique de tes pros, rendez-vous et conseils.",
      "Profite de recommandations très ciblées (pros, produits, événements).",
    ],
    kpis: [
      "Nombre de visites récurrentes par propriétaire.",
      "Nombre de pros différents consultés par compte.",
      "Engagement sur les contenus, clubs, boutique.",
    ],
    frictions: [
      "Le propriétaire ne voit pas la valeur d’un compte ou n’a pas l’habitude de se reconnecter.",
    ],
    improvements: [
      "Mettre en avant les bénéfices concrets d’un compte (historique, rappels, recommandations adaptées).",
      "Proposer des challenges / gamification douce pour encourager le retour.",
    ],
    example:
      "Interface compte : « Tes animaux : Max, Nala. Prochain rappel : bilan éducatif dans 3 mois. Suggestions : atelier collectif chiots, article sur l’enrichissement du milieu. »",
  },
];

function setupTunnelParticulier() {
  const column = document.getElementById("funnelColumn");
  const detail = document.getElementById("funnelDetail");
  const summary = document.getElementById("tunnelSummaryList");
  if (!column || !detail || !summary) return;

  const icons = ["✨", "📍", "🔍", "📄", "🗓️", "✅", "🤝", "💌", "🎯"];
  let activeStepId = tunnelParticulierSteps[0]?.id;

  column.innerHTML = "";
  tunnelParticulierSteps.forEach((step, index) => {
    const el = document.createElement("button");
    el.type = "button";
    el.className = "funnel-step";
    el.dataset.stepId = step.id;
    el.style.setProperty("--step-shrink", `${index * 10}px`);
    el.innerHTML = `
      <div class="step-label">Étape ${step.order}/9</div>
      <div class="step-title"><span class="step-icon">${icons[index % icons.length]}</span>${step.title}</div>
    `;

    const activate = () => setActiveStep(step.id);
    el.addEventListener("click", activate);
    el.addEventListener("mouseover", activate);

    if (index === 0) {
      el.classList.add("funnel-step--active");
    }
    column.appendChild(el);
  });

  renderTunnelDetail(activeStepId, detail);
  renderTunnelSummary(summary);

  function setActiveStep(stepId) {
    if (!stepId || stepId === activeStepId) return;
    activeStepId = stepId;
    column.querySelectorAll(".funnel-step").forEach((el) => {
      el.classList.toggle("funnel-step--active", el.dataset.stepId === stepId);
    });
    renderTunnelDetail(stepId, detail);
  }

  const firstStep = column.querySelector(`[data-step-id="${activeStepId}"]`);
  if (firstStep) firstStep.classList.add("funnel-step--active");

  if (activeStepId) {
    renderTunnelDetail(activeStepId, detail);
  }
}

function renderTunnelDetail(stepId, container) {
  if (!container) return;
  const step = tunnelParticulierSteps.find((item) => item.id === stepId);
  if (!step) return;

  container.classList.remove("is-switching");
  // trigger reflow to restart animation
  // eslint-disable-next-line no-unused-expressions
  container.offsetHeight;
  container.classList.add("is-switching");

  const renderList = (title, items) => {
    if (!items || !items.length) return "";
    const listItems = items.map((item) => `<li>${item}</li>`).join("");
    return `
      <div class="detail-section">
        <h4>${title}</h4>
        <ul class="detail-list">${listItems}</ul>
      </div>
    `;
  };

  const subtitle = step.shortDescription || "";
  const example = step.example || "";

  container.innerHTML = `
    <h3>${step.title}</h3>
    <p class="detail-subtitle">${subtitle}</p>
    <div class="detail-columns">
      ${renderList("Contexte côté propriétaire", step.context)}
      ${renderList("Rôle de Planipets", step.role)}
      ${renderList("Messages & contenus clés", step.messages)}
      ${renderList("Indicateurs (KPI)", step.kpis)}
      ${renderList("Frictions & pistes d’amélioration", step.frictions)}
      ${renderList("Améliorations prévues", step.improvements)}
    </div>
    <div class="example-block">
      <strong>Exemple concret</strong>
      <p>${example}</p>
    </div>
  `;
}

function renderTunnelSummary(container) {
  if (!container) return;
  container.innerHTML = "";
  tunnelParticulierSteps.forEach((step) => {
    const card = document.createElement("article");
    card.className = "summary-card";
    card.innerHTML = `
      <div class="summary-step-label">Étape ${step.order}/9</div>
      <h3>${step.title}</h3>
      <p>${step.shortDescription}</p>
    `;
    container.appendChild(card);
  });
}

function setupAdPageInteractions() {
  const packsContainer = document.getElementById("packs-visibilite");
  const detailTitle = document.getElementById("pack-detail-title");
  const detailDescription = document.getElementById("pack-detail-description");
  const detailPoints = document.getElementById("pack-detail-points");
  const packCards = packsContainer?.querySelectorAll(".pack-card") || [];

  if (packsContainer && detailTitle && detailDescription && detailPoints && packCards.length) {
    const activateCard = (card) => {
      packCards.forEach((c) => c.classList.remove("pack-card--active"));
      card.classList.add("pack-card--active");

      const title = card.dataset.title || card.querySelector("h3")?.textContent || "Pack";
      const description =
        card.dataset.description || card.querySelector(".pack-baseline")?.textContent || "";
      const points = (card.dataset.points || "")
        .split(";")
        .map((p) => p.trim())
        .filter(Boolean);

      detailTitle.textContent = title;
      detailDescription.textContent = description;
      detailPoints.innerHTML = "";

      points.forEach((point) => {
        const li = document.createElement("li");
        li.textContent = point;
        detailPoints.appendChild(li);
      });
    };

    packCards.forEach((card) => {
      card.addEventListener("click", () => activateCard(card));
      card.addEventListener("mouseenter", () => activateCard(card));
    });

    activateCard(packCards[0]);
  }

  const faqButtons = document.querySelectorAll(".faq-question");
  if (faqButtons.length) {
    faqButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".faq-item");
        const isOpen = item?.classList.contains("is-open");

        document.querySelectorAll(".faq-item.is-open").forEach((openItem) => {
          openItem.classList.remove("is-open");
        });

        if (item && !isOpen) {
          item.classList.add("is-open");
        }
      });
    });
  }

  const heroCta = document.getElementById("cta-annonceurs");
  if (heroCta) {
    heroCta.addEventListener("click", (event) => {
      event.preventDefault();
      document
        .getElementById("contact-annonceurs")
        ?.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  }
}

function initGamificationParticulier() {
  const root = document.getElementById("gamificationParticulierRoot");
  if (!root) return;

  const levelList = document.getElementById("particulierLevelList");
  const levelDetail = document.getElementById("particulierLevelDetail");
  const questTable = document.getElementById("particulierQuestTable");
  const skillTree = document.getElementById("particulierSkillTree");
  const skillDetail = document.getElementById("particulierSkillDetail");
  const shopGrid = document.getElementById("particulierShop");
  const shopDetail = document.getElementById("particulierShopDetail");

  const animateDetail = (el) => {
    if (!el) return;
    el.classList.remove("detail-fade-in");
    void el.offsetWidth;
    el.classList.add("detail-fade-in");
  };

  const gamificationParticulierLevels = [
    {
      id: "p1",
      title: "Niveau 1 – Découvreur",
      range: "0–199 XP",
      description: "Tu découvres Planipets et prends en main ton espace.",
      benefits: ["Badge \"Découvreur\"", "Accès aux quêtes de base"],
    },
    {
      id: "p2",
      title: "Niveau 2 – Gardien attentif",
      range: "200–599 XP",
      description: "Tu commences à suivre régulièrement le bien-être de ton animal.",
      benefits: [
        "Badge \"Gardien attentif\"",
        "Suggestions d’articles personnalisés",
        "Premiers codes promo / offres test (placeholder)",
      ],
    },
    {
      id: "p3",
      title: "Niveau 3 – Protecteur engagé",
      range: "600–1 299 XP",
      description: "Tu utilises Planipets pour prévenir plutôt que subir.",
      benefits: [
        "Badge \"Protecteur engagé\"",
        "Accès à des quêtes intermédiaires",
        "Invitations à des webinaires thématiques",
      ],
    },
    {
      id: "p4",
      title: "Niveau 4 – Complice exemplaire",
      range: "1 300–2 499 XP",
      description: "Tu es très actif : avis, quêtes, suivi régulier.",
      benefits: [
        "Badge \"Complice exemplaire\"",
        "Accès prioritaire à certains événements / lives",
        "Avantages renforcés en boutique (ex : options réservées aux niveaux 4+)",
      ],
    },
    {
      id: "p5",
      title: "Niveau 5 – Héros Planipets",
      range: "2 500+ XP",
      description: "Ton compte devient un vrai carnet de vie pour ton animal.",
      benefits: [
        "Badge \"Héros Planipets\"",
        "Accès à tous les arcs de quêtes",
        "Invitations spéciales (tests de nouvelles fonctionnalités, clubs locaux, etc.)",
      ],
    },
  ];

  const particulierQuests = [
    {
      type: "Création du compte & profil de ton animal",
      examples: [
        "Créer ton compte Planipets et ajouter la fiche de ton animal.",
        "Compléter les infos clés (âge, poids, habitudes, particularités).",
      ],
      reward: "+50 XP · +20 points",
    },
    {
      type: "Première prise de rendez-vous via Planipets",
      examples: ["Réserver un rendez-vous avec un pro (éducateur, comportementaliste, toiletteur…)."],
      reward: "+80 XP · +40 points",
    },
    {
      type: "Laisser un avis après un rendez-vous",
      examples: [
        "Donner une note et un retour sur la séance.",
        "Aide d’autres propriétaires à choisir en confiance.",
      ],
      reward: "+40 XP · +20 points",
    },
    {
      type: "Lire un article et cocher une mini check-list",
      examples: [
        "Lire un article ‘Prévenir l’ennui chez le chat d’intérieur’ et cocher les actions que tu appliques.",
      ],
      reward: "+20 XP · +10 points",
    },
    {
      type: "Participer à un défi bien-être",
      examples: ["Challenge 7 jours : 10 minutes de jeu par jour avec ton chien / chat."],
      reward: "+100 XP · +50 points",
    },
  ];

  const particulierSkillTree = [
    {
      branch: "Santé & prévention",
      nodes: [
        {
          title: "Vaccins & visites régulières",
          quests: ["Renseigner la date du dernier vaccin"],
          reward: "+25 XP · +10 points",
        },
        {
          title: "Suivi du poids",
          quests: ["Ajouter le poids de ton animal ce mois-ci"],
          reward: "+15 XP · +8 points",
        },
        {
          title: "Prévention parasites",
          quests: ["Lire un article sur la prévention des tiques"],
          reward: "+20 XP · +10 points",
        },
      ],
    },
    {
      branch: "Éducation & comportement",
      nodes: [
        {
          title: "Apprentissages de base",
          quests: ["Appliquer un exercice simple 3 jours de suite et cocher la case"],
          reward: "+30 XP · +12 points",
        },
        {
          title: "Gestion de la peur / réactivité",
          quests: ["Prendre un RDV avec un éducateur si nécessaire"],
          reward: "+40 XP · +20 points",
        },
        {
          title: "Jeu structuré",
          quests: ["Prévoir 10 minutes de jeu guidé et le reporter"],
          reward: "+24 XP · +12 points",
        },
      ],
    },
    {
      branch: "Activité & environnement",
      nodes: [
        {
          title: "Activité physique",
          quests: ["Reporter la durée des sorties sur une semaine"],
          reward: "+28 XP · +12 points",
        },
        {
          title: "Enrichissement de l’environnement",
          quests: ["Ajouter un nouveau jeu d’enrichissement"],
          reward: "+24 XP · +10 points",
        },
        {
          title: "Routine quotidienne",
          quests: ["Cadrer la routine matin/soir pendant 5 jours"],
          reward: "+22 XP · +10 points",
        },
      ],
    },
    {
      branch: "Lien émotionnel & quotidien",
      nodes: [
        {
          title: "Interpréter les signaux de ton animal",
          quests: ["Lire un article sur les signaux d’apaisement"],
          reward: "+20 XP · +10 points",
        },
        {
          title: "Créer des rituels positifs",
          quests: ["Faire un rituel calme le soir pendant 7 jours"],
          reward: "+32 XP · +14 points",
        },
        {
          title: "Réduire le stress au quotidien",
          quests: ["Tester une astuce anti-stress validée par un pro"],
          reward: "+24 XP · +12 points",
        },
      ],
    },
  ];

  const particulierShop = [
    {
      title: "Pack avatars & badges premium",
      cost: "150 points",
      description: "Badges visuels spéciaux, thèmes de profil, avatars pour ton animal.",
    },
    {
      title: "Accès à un atelier en ligne",
      cost: "300 points",
      description: "Atelier en visio avec un pro sur un thème (prévention, jeu, cohabitation…).",
    },
    {
      title: "Réduction chez un pro partenaire",
      cost: "400 points",
      description: "Code promo pour une séance ou un pack (ex : -10 %, placeholder).",
    },
    {
      title: "Accès anticipé à une nouvelle fonctionnalité Planipets",
      cost: "250 points",
      description: "Tu testes en avant-première des nouveautés.",
    },
  ];

  if (questTable) {
    renderQuestTable(questTable, particulierQuests);
  }

  if (levelList && levelDetail && gamificationParticulierLevels.length) {
    gamificationParticulierLevels.forEach((level, index) => {
      const item = document.createElement("button");
      item.className = "level-item";
      item.innerHTML = `<div class="level-item-title">${level.title}</div><div class="level-item-range">${level.range}</div>`;
      item.addEventListener("click", () => renderParticulierLevel(level.id));
      item.addEventListener("mouseenter", () => renderParticulierLevel(level.id));
      levelList.appendChild(item);
      if (index === 0) {
        item.classList.add("level-item--active");
      }
    });

    const renderParticulierLevel = (levelId) => {
      const level = gamificationParticulierLevels.find((l) => l.id === levelId) || gamificationParticulierLevels[0];

      levelList.querySelectorAll(".level-item").forEach((btn, idx) => {
        const matches = gamificationParticulierLevels[idx].id === level.id;
        btn.classList.toggle("level-item--active", matches);
      });

      levelDetail.innerHTML = `
        <div class="level-meta">${level.range}</div>
        <h3>${level.title}</h3>
        <p>${level.description}</p>
        <ul class="level-benefits">${level.benefits.map((b) => `<li>${b}</li>`).join("")}</ul>
      `;
      animateDetail(levelDetail);
    };

    renderParticulierLevel(gamificationParticulierLevels[0].id);
  }

  if (skillTree && skillDetail && particulierSkillTree.length) {
    particulierSkillTree.forEach((branch) => {
      const branchEl = document.createElement("div");
      branchEl.className = "skill-branch";
      branchEl.innerHTML = `<h4>${branch.branch}</h4>`;
      const nodeList = document.createElement("div");
      nodeList.className = "skill-node-list";

      branch.nodes.forEach((node) => {
        const nodeEl = document.createElement("button");
        nodeEl.className = "skill-node";
        nodeEl.textContent = node.title;
        nodeEl.addEventListener("mouseenter", () => updateSkillDetail(branch.branch, node));
        nodeEl.addEventListener("click", () => updateSkillDetail(branch.branch, node));
        nodeList.appendChild(nodeEl);
      });

      branchEl.appendChild(nodeList);
      skillTree.appendChild(branchEl);
    });

    const updateSkillDetail = (branchName, node) => {
      skillDetail.innerHTML = `
        <strong>${branchName} · ${node.title}</strong>
        <p>${node.quests.join(" ")}</p>
        <p class="muted">Récompense indicative : ${node.reward}</p>
      `;
      animateDetail(skillDetail);
    };

    const [firstBranch] = particulierSkillTree;
    if (firstBranch && firstBranch.nodes.length) {
      updateSkillDetail(firstBranch.branch, firstBranch.nodes[0]);
    }
  }

  if (shopGrid && shopDetail && particulierShop.length) {
    const renderShopDetail = (item) => {
      shopDetail.innerHTML = `
        <strong>${item.title}</strong>
        <p class="cost">${item.cost}</p>
        <p>${item.description}</p>
      `;
      animateDetail(shopDetail);
    };

    particulierShop.forEach((item, idx) => {
      const card = document.createElement("button");
      card.className = "shop-item";
      card.innerHTML = `<div class="shop-title">${item.title}</div><div class="cost">${item.cost}</div><p>${item.description}</p>`;
      card.addEventListener("click", () => activateCard(card, item));
      card.addEventListener("mouseenter", () => activateCard(card, item));
      shopGrid.appendChild(card);

      if (idx === 0) {
        card.classList.add("shop-item--active");
        renderShopDetail(item);
      }
    });

    const activateCard = (card, item) => {
      shopGrid.querySelectorAll(".shop-item").forEach((c) => c.classList.remove("shop-item--active"));
      card.classList.add("shop-item--active");
      renderShopDetail(item);
    };
  }

  const ctaVoirComment = document.getElementById("ctaVoirComment");
  if (ctaVoirComment) {
    ctaVoirComment.addEventListener("click", (event) => {
      event.preventDefault();
      document
        .getElementById("pourquoi-particulier")
        ?.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  }
}

function initGamificationPro() {
  const root = document.getElementById("gamificationProRoot");
  if (!root) return;

  const levelList = document.getElementById("proLevelList");
  const levelDetail = document.getElementById("proLevelDetail");
  const questTable = document.getElementById("proQuestTable");
  const skillTree = document.getElementById("proSkillTree");
  const skillDetail = document.getElementById("proSkillDetail");
  const shopGrid = document.getElementById("proShop");
  const shopDetail = document.getElementById("proShopDetail");

  const animateDetail = (el) => {
    if (!el) return;
    el.classList.remove("detail-fade-in");
    void el.offsetWidth;
    el.classList.add("detail-fade-in");
  };

  const gamificationProLevels = [
    {
      id: "pro1",
      title: "Niveau 1 – Explorateur",
      range: "0–299 XP Pro",
      description: "Tu découvres l’écosystème Planipets.",
      benefits: ["Badge Explorateur sur ton espace Pro.", "Accès aux quêtes de base."],
    },
    {
      id: "pro2",
      title: "Niveau 2 – Partenaire",
      range: "300–899 XP Pro",
      description: "Ton profil est en ligne, tu commences à recevoir des rendez-vous.",
      benefits: [
        "Badge Partenaire.",
        "Accès à des statistiques simples sur tes rendez-vous.",
        "Accès aux premiers slots de mise en avant (via la boutique).",
      ],
    },
    {
      id: "pro3",
      title: "Niveau 3 – Référent local",
      range: "900–2 299 XP Pro",
      description: "Tu es régulièrement choisi dans ta zone.",
      benefits: [
        "Badge Référent local.",
        "Visibilité renforcée dans certaines listes (ex : tag ‘Recommandé’).",
        "Priorité pour certains programmes pilotes (boutique, campagnes).",
      ],
    },
    {
      id: "pro4",
      title: "Niveau 4 – Expert Planipets",
      range: "2 300–4 499 XP Pro",
      description: "Tu t’impliques dans la communauté et la pédagogie.",
      benefits: [
        "Badge Expert Planipets.",
        "Accès à des modules de formation avancés.",
        "Visibilité renforcée dans les contenus (ex : citations, interviews).",
      ],
    },
    {
      id: "pro5",
      title: "Niveau 5 – Ambassadeur",
      range: "4 500+ XP Pro",
      description: "Tu deviens un partenaire clé de Planipets.",
      benefits: [
        "Badge Ambassadeur.",
        "Accès aux programmes d’ambassadeurs (co-création, événements, co-branding).",
        "Conditions privilégiées sur certains leviers (à définir).",
      ],
    },
  ];

  const proQuests = [
    {
      type: "Fiche Pro complète",
      examples: ["Compléter photo, bio, tarifs, zones d’intervention."],
      reward: "+90 XP Pro · +40 points Pro",
    },
    {
      type: "Activation de l’agenda",
      examples: ["Activer tes créneaux réservables et confirmer ton premier rendez-vous."],
      reward: "+110 XP Pro · +60 points Pro",
    },
    {
      type: "Collecte d’avis",
      examples: ["Obtenir X avis avec note ≥ 4,5.", "Répondre aux retours pour rassurer les futurs clients."],
      reward: "+70 XP Pro · +30 points Pro",
    },
    {
      type: "Participation formation / live",
      examples: ["Participer à un live ou atelier ‘Communication avec les clients humains’."],
      reward: "+60 XP Pro · +30 points Pro",
    },
    {
      type: "Contribution média",
      examples: ["Contribuer à un article ou témoignage sur Planipets Media."],
      reward: "+80 XP Pro · +40 points Pro",
    },
  ];

  const gamificationProSkillTree = [
    {
      branch: "Qualité de service & bien-être animal",
      nodes: [
        {
          title: "Charte Planipets signée & intégrée",
          quests: ["Compléter & valider la charte sur ton espace Pro."],
          reward: "+60 XP Pro · +30 points Pro",
        },
        {
          title: "Collecte d’avis de qualité",
          quests: ["Obtenir X avis avec note ≥ 4,5."],
          reward: "+70 XP Pro · +30 points Pro",
        },
        {
          title: "Suivi post-séance",
          quests: ["Mettre en place un message post-séance via Planipets."],
          reward: "+55 XP Pro · +24 points Pro",
        },
      ],
    },
    {
      branch: "Relation & pédagogie avec les humains",
      nodes: [
        {
          title: "Explication claire des méthodes",
          quests: ["Rédiger un texte pédagogique dans ta fiche Pro."],
          reward: "+45 XP Pro · +20 points Pro",
        },
        {
          title: "Gestion des attentes clients",
          quests: ["Créer un guide d’accueil envoyable après chaque prise de rendez-vous."],
          reward: "+50 XP Pro · +22 points Pro",
        },
        {
          title: "Outils pédagogiques",
          quests: ["Participer à un live ou atelier ‘Communication avec les clients humains’."],
          reward: "+60 XP Pro · +30 points Pro",
        },
      ],
    },
    {
      branch: "Visibilité & marketing éthique",
      nodes: [
        {
          title: "Profil complet & cohérent",
          quests: ["Compléter photo, bio, tarifs, zones d’intervention."],
          reward: "+65 XP Pro · +28 points Pro",
        },
        {
          title: "Participation à des contenus média",
          quests: ["Contribuer à un article ou témoignage sur Planipets Media."],
          reward: "+80 XP Pro · +40 points Pro",
        },
        {
          title: "Présence locale amplifiée",
          quests: ["Partager une actualité locale ou un atelier sur Planipets."],
          reward: "+55 XP Pro · +26 points Pro",
        },
      ],
    },
    {
      branch: "Vie de la communauté & co-construction",
      nodes: [
        {
          title: "Participation aux groupes / forum",
          quests: ["Répondre à une discussion d’entraide (forum, groupe…)."],
          reward: "+45 XP Pro · +20 points Pro",
        },
        {
          title: "Parrainage de nouveaux pros",
          quests: ["Parrainer un pro qui signe & s’active."],
          reward: "+70 XP Pro · +35 points Pro",
        },
        {
          title: "Feedback produit structuré",
          quests: ["Participer à un atelier feedback sur de nouvelles fonctionnalités."],
          reward: "+60 XP Pro · +28 points Pro",
        },
      ],
    },
  ];

  const proShopItems = [
    {
      title: "Boost visibilité 7 jours",
      cost: "300 points Pro",
      description: "Mise en avant de ta fiche sur certaines pages / résultats (placeholders).",
    },
    {
      title: "Slot newsletter Pro ou grand public",
      cost: "500 points Pro",
      description: "Mention de ton activité dans une newsletter ciblée (Pro ou particuliers).",
    },
    {
      title: "Réduction sur accompagnement Planipets",
      cost: "400 points Pro",
      description: "Réduction sur un accompagnement / coaching avec l’équipe Planipets.",
    },
    {
      title: "Accès à un module de formation avancé",
      cost: "250 points Pro",
      description: "Formation sur un sujet clé (marketing éthique, gestion de clientèle, etc.).",
    },
  ];

  if (questTable) {
    renderQuestTable(questTable, proQuests);
  }

  if (levelList && levelDetail && gamificationProLevels.length) {
    gamificationProLevels.forEach((level, index) => {
      const item = document.createElement("button");
      item.className = "level-item";
      item.innerHTML = `<div class="level-item-title">${level.title}</div><div class="level-item-range">${level.range}</div>`;
      item.addEventListener("click", () => renderProLevel(level.id));
      item.addEventListener("mouseenter", () => renderProLevel(level.id));
      levelList.appendChild(item);
      if (index === 0) {
        item.classList.add("level-item--active");
      }
    });

    const renderProLevel = (levelId) => {
      const level = gamificationProLevels.find((l) => l.id === levelId) || gamificationProLevels[0];

      levelList.querySelectorAll(".level-item").forEach((btn, idx) => {
        const matches = gamificationProLevels[idx].id === level.id;
        btn.classList.toggle("level-item--active", matches);
      });

      levelDetail.innerHTML = `
        <div class="level-meta">${level.range}</div>
        <h3>${level.title}</h3>
        <p>${level.description}</p>
        <ul class="level-benefits">${level.benefits.map((b) => `<li>${b}</li>`).join("")}</ul>
      `;
      animateDetail(levelDetail);
    };

    renderProLevel(gamificationProLevels[0].id);
  }

  if (skillTree && skillDetail && gamificationProSkillTree.length) {
    gamificationProSkillTree.forEach((branch) => {
      const branchEl = document.createElement("div");
      branchEl.className = "skill-branch";
      branchEl.innerHTML = `<h4>${branch.branch}</h4>`;
      const nodeList = document.createElement("div");
      nodeList.className = "skill-node-list";

      branch.nodes.forEach((node) => {
        const nodeEl = document.createElement("button");
        nodeEl.className = "skill-node";
        nodeEl.textContent = node.title;
        nodeEl.addEventListener("mouseenter", () => updateSkillDetail(branch.branch, node));
        nodeEl.addEventListener("click", () => updateSkillDetail(branch.branch, node));
        nodeList.appendChild(nodeEl);
      });

      branchEl.appendChild(nodeList);
      skillTree.appendChild(branchEl);
    });

    const updateSkillDetail = (branchName, node) => {
      skillDetail.innerHTML = `
        <strong>${branchName} · ${node.title}</strong>
        <p>${node.quests.join(" ")}</p>
        <p class="muted">Récompense indicative : ${node.reward}</p>
      `;
      animateDetail(skillDetail);
    };

    const [firstBranch] = gamificationProSkillTree;
    if (firstBranch && firstBranch.nodes.length) {
      updateSkillDetail(firstBranch.branch, firstBranch.nodes[0]);
    }
  }

  if (shopGrid && shopDetail && proShopItems.length) {
    const renderShopDetail = (item) => {
      shopDetail.innerHTML = `
        <strong>${item.title}</strong>
        <p class="cost">${item.cost}</p>
        <p>${item.description}</p>
      `;
      animateDetail(shopDetail);
    };

    proShopItems.forEach((item, idx) => {
      const card = document.createElement("button");
      card.className = "shop-item";
      card.innerHTML = `<div class="shop-title">${item.title}</div><div class="cost">${item.cost}</div><p>${item.description}</p>`;
      card.addEventListener("click", () => activateCard(card, item));
      card.addEventListener("mouseenter", () => activateCard(card, item));
      shopGrid.appendChild(card);

      if (idx === 0) {
        card.classList.add("shop-item--active");
        renderShopDetail(item);
      }
    });

    const activateCard = (card, item) => {
      shopGrid.querySelectorAll(".shop-item").forEach((c) => c.classList.remove("shop-item--active"));
      card.classList.add("shop-item--active");
      renderShopDetail(item);
    };
  }
}

function renderQuestTable(container, quests) {
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");

  thead.innerHTML = `
    <tr>
      <th>Type d’action</th>
      <th>Exemple concret</th>
      <th>XP + Points boutique obtenus</th>
    </tr>
  `;

  quests.forEach((quest) => {
    const row = document.createElement("tr");
    const examples = quest.examples.map((ex) => `<div>${ex}</div>`).join("");
    row.innerHTML = `
      <td>${quest.type}</td>
      <td>${examples}</td>
      <td><strong>${quest.reward}</strong></td>
    `;
    tbody.appendChild(row);
  });

  table.appendChild(thead);
  table.appendChild(tbody);
  container.appendChild(table);
}
